<div class="app-shell" data-testid="users-app">
  <!-- Header -->
  <header class="app-header" data-testid="users-header">
    <div class="header-left">
      <div class="logo-dot"></div>
      <h1 class="app-title">
        <span class="accent">Users</span>
        <span class="subtitle">Management</span>
      </h1>
    </div>

    <div class="header-right">
      <!-- Tab Navigation -->
      <nav class="tab-nav" data-testid="tab-navigation">
        @for (tab of tabs; track tab.id) {
          <button
            class="tab-btn"
            [class.active]="activeTab() === tab.id"
            (click)="setActiveTab(tab.id)"
            [attr.data-testid]="'tab-' + tab.id"
          >
            {{ tab.label }}
          </button>
        }
      </nav>

      <div class="header-divider"></div>

      <!-- Invite Button -->
      <ui-action-button variant="primary" (clicked)="openInviteForm()" data-testid="invite-user-button">
        + Invite User
      </ui-action-button>

      <!-- Theme Toggle -->
      <ui-theme-toggle />
    </div>
  </header>

  <!-- Content Area -->
  <main class="app-content" data-testid="users-content">
    @if (activeTab() === 'users') {
      <div class="users-layout" data-testid="users-layout">
        <!-- Users List Panel -->
        <div class="users-panel" data-testid="users-panel">
          <!-- Stats Bar -->
          <div class="stats-bar" data-testid="stats-bar">
            <div class="stats-group">
              @for (stat of stats(); track stat.label) {
                <div class="stat-item" [attr.data-testid]="'stat-' + stat.label.toLowerCase()">
                  <span class="stat-label">{{ stat.label }}</span>
                  <span class="stat-value" [style.color]="'var(' + stat.colorVar + ')'">
                    {{ stat.value }}
                  </span>
                </div>
              }
            </div>
            <div class="filters-group">
              <input
                type="text"
                class="search-input"
                placeholder="Search users..."
                [value]="searchQuery()"
                (input)="setSearchQuery($any($event.target).value)"
                data-testid="search-users-input"
              />
              <select
                class="company-select"
                [value]="filterCompany()"
                (change)="setFilterCompany($any($event.target).value)"
                data-testid="company-filter-select"
              >
                <option value="all">All Companies</option>
                @for (company of companies(); track company) {
                  <option [value]="company">{{ company }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Role Filter Chips -->
          <div class="role-chips" data-testid="role-filter-chips">
            @for (filter of roleFilters(); track filter.key) {
              <ui-filter-chip
                [active]="filterRole() === filter.key"
                (clicked)="setFilterRole(filter.key)"
                [attr.data-testid]="'role-filter-' + filter.key"
              >
                {{ filter.label }}
              </ui-filter-chip>
            }
          </div>

          <!-- Users List -->
          <proto-users-list
            [users]="filteredUsers()"
            [selectedUserId]="selectedUserId()"
            (userSelected)="selectUser($event)"
            data-testid="users-list"
          />
        </div>

        <!-- User Details Panel -->
        <aside class="details-panel" data-testid="user-details-panel">
          <proto-user-details
            [user]="selectedUser()"
            (edit)="openEditForm($event)"
            (delete)="deleteUser($event)"
            data-testid="user-details"
          />
        </aside>
      </div>
    }

    @if (activeTab() === 'companies') {
      <div class="companies-layout" data-testid="companies-layout">
        <!-- Companies List Panel -->
        <div class="companies-panel" data-testid="companies-panel">
          <div class="panel-header">
            <h3 class="panel-title">Companies</h3>
            <ui-action-button variant="primary" (clicked)="openAddCompanyForm()" data-testid="add-company-button">
              + Add
            </ui-action-button>
          </div>
          <proto-companies-list
            [companies]="allCompanies()"
            [selectedCompanyId]="selectedCompanyId()"
            [userCounts]="userCountsByCompany()"
            (companySelected)="selectCompany($event)"
            data-testid="companies-list"
          />
        </div>

        <!-- Company Details Panel -->
        <aside class="details-panel" data-testid="company-details-panel">
          <proto-company-details
            [company]="selectedCompany()"
            [users]="users()"
            (edit)="openEditCompanyForm($event)"
            (delete)="deleteCompany($event)"
            data-testid="company-details"
          />
        </aside>
      </div>
    }

    @if (activeTab() === 'roles') {
      <proto-roles-tab
        [roleConfigs]="roleConfigs"
        [getUserCount]="getUserCountByRole.bind(this)"
        data-testid="roles-tab"
      />
    }

    @if (activeTab() === 'audit') {
      <proto-audit-tab [auditLog]="auditLog" data-testid="audit-tab" />
    }
  </main>
</div>

<!-- User Form Modal -->
@if (showUserForm()) {
  <proto-user-form
    [user]="editingUser()"
    [companies]="allCompanies()"
    (save)="saveUser($event)"
    (cancel)="closeForm()"
    data-testid="user-form-modal"
  />
}

<!-- Delete User Confirmation Dialog -->
@if (showDeleteConfirm() && deletingUser(); as user) {
  <ui-confirm-dialog
    title="Delete User"
    [message]="'Are you sure you want to delete this user?'"
    [details]="user.firstName + ' ' + user.lastName + ' (' + user.email + ')'"
    confirmLabel="Delete User"
    cancelLabel="Cancel"
    confirmVariant="danger"
    (confirm)="confirmDelete()"
    (cancel)="cancelDelete()"
    data-testid="delete-user-dialog"
  />
}

<!-- Company Form Modal -->
@if (showCompanyForm()) {
  <proto-company-form
    [company]="editingCompany()"
    (save)="saveCompany($event)"
    (cancel)="closeCompanyForm()"
    data-testid="company-form-modal"
  />
}

<!-- Delete Company Confirmation Dialog -->
@if (showCompanyDeleteConfirm() && deletingCompany(); as company) {
  <ui-confirm-dialog
    title="Delete Company"
    [message]="'Are you sure you want to delete this company?'"
    [details]="company.name"
    confirmLabel="Delete Company"
    cancelLabel="Cancel"
    confirmVariant="danger"
    (confirm)="confirmCompanyDelete()"
    (cancel)="cancelCompanyDelete()"
    data-testid="delete-company-dialog"
  />
}
