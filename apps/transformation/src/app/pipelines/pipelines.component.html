<div class="shell">
  <!-- Header -->
  <ui-page-header title="Transformation" subtitle="Pipelines">
    <div slot="actions" class="header-actions">
      <button
        type="button"
        class="history-btn"
        [class.active]="showRunHistory()"
        (click)="toggleRunHistory()"
      >
        <span class="icon">&#9697;</span> Run History
      </button>
      <ui-action-button variant="primary" (clicked)="createNewPipeline()">
        + New Pipeline
      </ui-action-button>
      <ui-theme-toggle />
    </div>
  </ui-page-header>

  <!-- Stacked Layout -->
  <div class="stacked-layout">
    <!-- Top: Full-width Canvas -->
    <div class="canvas-section">
      @if (showRunHistory()) {
        <proto-run-history-panel [runs]="runHistory()" />
      } @else {
        <!-- Pipeline Header Bar -->
        @if (currentPipeline(); as pipeline) {
          <div class="pipeline-header">
            <div class="pipeline-info">
              <span class="pipeline-name">{{ pipeline.name }}</span>
              <ui-status-dot
                [status]="getStatusType(pipeline.status)"
                [showLabel]="true"
              />
            </div>
            <div class="pipeline-stats">
              <span class="stat">Last: {{ pipeline.lastRunAt || 'Never' }}</span>
              <span class="stat">{{ pipeline.successRate }}% success</span>
              <span class="stat">{{ currentSteps().length }} steps</span>
            </div>
          </div>
        }

        <!-- Canvas -->
        @if (currentSteps().length > 0) {
          <proto-pipeline-canvas
            [steps]="currentSteps()"
            [edges]="currentEdges()"
            [selectedStepId]="selectedStepId()"
            (stepSelected)="selectStep($event)"
          />
        } @else {
          <div class="empty-canvas">
            @if (currentPipeline()?.status === 'draft') {
              <span>This pipeline has no steps yet.</span>
            } @else {
              <span>Select a pipeline to view its flow.</span>
            }
          </div>
        }
      }
    </div>

    <!-- Bottom: Three Column Panel -->
    @if (!showRunHistory()) {
      <div class="panels-strip">
        <!-- Column 1: Pipeline List -->
        <div class="panel-col pipeline-list-col">
          <proto-pipeline-sidebar
            [pipelines]="pipelines()"
            [selectedId]="selectedPipelineId()"
            (pipelineSelected)="selectPipeline($event)"
            (searchChanged)="onSearch($event)"
          />
        </div>

        <!-- Column 2: Step Details -->
        <div class="panel-col step-details-col">
          @if (selectedStep(); as step) {
            <div class="step-details-content">
              <div class="step-header-info">
                <div class="step-icon">{{ getStepIcon(step.type) }}</div>
                <div class="step-meta">
                  <div class="step-name">{{ step.name }}</div>
                  <div class="step-type">{{ step.type | uppercase }} STEP</div>
                </div>
              </div>
              <div class="step-config">
                <div class="config-label">Configuration</div>
                <div class="config-code">{{ step.config }}</div>
              </div>
              <div class="step-metrics">
                <div class="metric">
                  <div class="metric-label">Input Records</div>
                  <div class="metric-value">{{ formatRecords(step.records) }}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Avg Duration</div>
                  <div class="metric-value">---</div>
                </div>
              </div>
              <div class="step-actions">
                <button class="action-btn primary">Edit Step</button>
                <button class="action-btn secondary">Preview Data</button>
              </div>
            </div>
          } @else {
            <div class="empty-step-details">
              Click a node to<br />inspect configuration
            </div>
          }
        </div>

        <!-- Column 3: Add Step -->
        <div class="panel-col add-step-col">
          <div class="add-step-header">Add Step</div>
          <div class="add-step-buttons">
            <button class="add-step-btn"><span class="icon">&#8856;</span> Filter</button>
            <button class="add-step-btn"><span class="icon">&#8674;</span> Map</button>
            <button class="add-step-btn"><span class="icon">&#931;</span> Aggregate</button>
            <button class="add-step-btn"><span class="icon">&#8904;</span> Join</button>
            <button class="add-step-btn"><span class="icon">&#8597;</span> Sort</button>
            <button class="add-step-btn"><span class="icon">&#8860;</span> Dedupe</button>
          </div>
        </div>
      </div>
    }
  </div>
</div>
