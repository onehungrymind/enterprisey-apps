<div class="shell">
  <!-- Header -->
  <ui-page-header title="Transformation" subtitle="Pipelines">
    <div slot="actions" class="header-actions">
      <button
        type="button"
        class="history-btn"
        [class.active]="showRunHistory()"
        (click)="toggleRunHistory()"
      >
        <span class="icon">&#9697;</span> Run History
      </button>
      <ui-action-button variant="primary" (clicked)="createNewPipeline()">
        + New Pipeline
      </ui-action-button>
      <ui-theme-toggle />
    </div>
  </ui-page-header>

  <!-- Main Layout -->
  <div class="main-layout">
    <!-- Left Sidebar: Pipeline List -->
    <proto-pipeline-sidebar
      [pipelines]="pipelines()"
      [selectedId]="selectedPipelineId()"
      (pipelineSelected)="selectPipeline($event)"
      (searchChanged)="onSearch($event)"
    />

    <!-- Center: Canvas or Run History -->
    @if (showRunHistory()) {
      <proto-run-history-panel [runs]="runHistory()" />
    } @else {
      <div class="canvas-area">
        <!-- Pipeline Header Bar -->
        @if (currentPipeline(); as pipeline) {
          <div class="pipeline-header">
            <div class="pipeline-info">
              <span class="pipeline-name">{{ pipeline.name }}</span>
              <ui-status-dot
                [status]="getStatusType(pipeline.status)"
                [showLabel]="true"
              />
            </div>
            <div class="pipeline-stats">
              <span class="stat">Last: {{ pipeline.lastRunAt || 'Never' }}</span>
              <span class="stat">{{ pipeline.successRate }}% success</span>
              <span class="stat">{{ currentSteps().length }} steps</span>
            </div>
          </div>
        }

        <!-- Canvas -->
        @if (currentSteps().length > 0) {
          <proto-pipeline-canvas
            [steps]="currentSteps()"
            [edges]="currentEdges()"
            [selectedStepId]="selectedStepId()"
            (stepSelected)="selectStep($event)"
          />
        } @else {
          <div class="empty-canvas">
            @if (currentPipeline()?.status === 'draft') {
              <span>This pipeline has no steps yet.</span>
            } @else {
              <span>No visual data available.</span>
            }
          </div>
        }
      </div>
    }

    <!-- Right Panel: Step Inspector -->
    @if (!showRunHistory()) {
      <proto-step-inspector [step]="selectedStep()" />
    }
  </div>
</div>
