<div class="shell" data-testid="transformation-app">
  <!-- Header -->
  <ui-page-header title="Transformation" subtitle="Pipelines">
    <div slot="actions" class="header-actions">
      <button
        type="button"
        class="history-btn"
        [class.active]="showRunHistory()"
        (click)="toggleRunHistory()"
        data-testid="run-history-button"
      >
        <span class="icon">&#9697;</span> Run History
      </button>
      <ui-action-button variant="primary" (clicked)="createNewPipeline()" data-testid="new-pipeline-button">
        + New Pipeline
      </ui-action-button>
      <ui-theme-toggle />
    </div>
  </ui-page-header>

  <!-- Stacked Layout -->
  <div class="stacked-layout">
    <!-- Top: Full-width Canvas -->
    <div class="canvas-section">
      @if (showRunHistory()) {
        <proto-run-history-panel [runs]="runHistory()" />
      } @else {
        <!-- Pipeline Header Bar -->
        @if (currentPipeline(); as pipeline) {
          <div class="pipeline-header" data-testid="pipeline-header">
            <div class="pipeline-info">
              <span class="pipeline-name" data-testid="pipeline-name">{{ pipeline.name }}</span>
              <ui-status-dot
                [status]="getStatusType(pipeline.status)"
                [showLabel]="true"
                data-testid="pipeline-status"
              />
            </div>
            <div class="pipeline-actions" data-testid="pipeline-actions">
              <button
                class="header-action-btn run-btn"
                (click)="runPipeline()"
                [disabled]="!pipeline.id || currentSteps().length === 0"
                data-testid="run-pipeline-button"
              >
                Run
              </button>
              <button
                class="header-action-btn"
                (click)="editPipeline(pipeline)"
                data-testid="edit-pipeline-button"
              >
                Edit
              </button>
              <button
                class="header-action-btn delete-btn"
                (click)="handleDeletePipeline(pipeline)"
                data-testid="delete-pipeline-button"
              >
                Delete
              </button>
            </div>
            <div class="pipeline-stats" data-testid="pipeline-stats">
              <span class="stat" data-testid="last-run">Last: {{ pipeline.lastRunAt || 'Never' }}</span>
              <span class="stat" data-testid="success-rate">{{ pipeline.successRate }}% success</span>
              <span class="stat" data-testid="step-count">{{ currentSteps().length }} steps</span>
            </div>
          </div>
        }

        <!-- Canvas -->
        @if (currentSteps().length > 0) {
          <proto-pipeline-canvas
            [steps]="currentSteps()"
            [edges]="currentEdges()"
            [selectedStepId]="selectedStepId()"
            (stepSelected)="selectStep($event)"
            data-testid="pipeline-canvas"
          />
        } @else {
          <div class="empty-canvas" data-testid="empty-canvas">
            @if (currentPipeline()?.status === 'draft') {
              <span>This pipeline has no steps yet.</span>
            } @else {
              <span>Select a pipeline to view its flow.</span>
            }
          </div>
        }
      }
    </div>

    <!-- Bottom: Three Column Panel -->
    @if (!showRunHistory()) {
      <div class="panels-strip">
        <!-- Column 1: Pipeline List -->
        <div class="panel-col pipeline-list-col" data-testid="pipelines-list-panel">
          <proto-pipeline-sidebar
            [pipelines]="pipelines()"
            [selectedId]="selectedPipelineId()"
            (pipelineSelected)="selectPipeline($event)"
            (searchChanged)="onSearch($event)"
            data-testid="pipelines-list"
          />
        </div>

        <!-- Column 2: Step Details -->
        <div class="panel-col step-details-col">
          @if (selectedStep(); as step) {
            <div class="step-details-content">
              <div class="step-header-info">
                <div class="step-icon">{{ getStepIcon(step.type) }}</div>
                <div class="step-meta">
                  <div class="step-name">{{ step.name }}</div>
                  <div class="step-type">{{ step.type | uppercase }} STEP</div>
                </div>
              </div>
              <div class="step-config">
                <div class="config-label">Configuration</div>
                <div class="config-code">{{ step.config }}</div>
              </div>
              <div class="step-metrics">
                <div class="metric">
                  <div class="metric-label">Input Records</div>
                  <div class="metric-value">{{ formatRecords(step.records) }}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Avg Duration</div>
                  <div class="metric-value">---</div>
                </div>
              </div>
              <div class="step-actions">
                <button class="action-btn primary" (click)="handleEditStep()">Edit Step</button>
                <button class="action-btn secondary">Preview Data</button>
              </div>
            </div>
          } @else {
            <div class="empty-step-details">
              Click a node to<br />inspect configuration
            </div>
          }
        </div>

        <!-- Column 3: Add Step -->
        <div class="panel-col add-step-col" data-testid="add-step-panel">
          <div class="add-step-header">Add Step</div>
          <div class="add-step-buttons" data-testid="step-type-buttons">
            <button
              class="add-step-btn"
              [disabled]="!currentPipeline()"
              (click)="addStep('filter')"
              data-testid="add-filter-step"
            >
              <span class="icon">&#8856;</span> Filter
            </button>
            <button
              class="add-step-btn"
              [disabled]="!currentPipeline()"
              (click)="addStep('map')"
              data-testid="add-map-step"
            >
              <span class="icon">&#8674;</span> Map
            </button>
            <button
              class="add-step-btn"
              [disabled]="!currentPipeline()"
              (click)="addStep('aggregate')"
              data-testid="add-aggregate-step"
            >
              <span class="icon">&#931;</span> Aggregate
            </button>
            <button
              class="add-step-btn"
              [disabled]="!currentPipeline()"
              (click)="addStep('join')"
              data-testid="add-join-step"
            >
              <span class="icon">&#8904;</span> Join
            </button>
            <button
              class="add-step-btn"
              [disabled]="!currentPipeline()"
              (click)="addStep('sort')"
              data-testid="add-sort-step"
            >
              <span class="icon">&#8597;</span> Sort
            </button>
            <button
              class="add-step-btn"
              [disabled]="!currentPipeline()"
              (click)="addStep('deduplicate')"
              data-testid="add-dedupe-step"
            >
              <span class="icon">&#8860;</span> Dedupe
            </button>
          </div>
        </div>
      </div>
    }
  </div>
</div>

<!-- Pipeline Form Modal -->
@if (showPipelineForm()) {
  <proto-pipeline-form
    [pipeline]="editingPipeline()"
    (save)="savePipeline($event)"
    (cancel)="closePipelineForm()"
  />
}

<!-- Step Form Modal -->
@if (showStepForm() && currentPipeline()?.id) {
  <proto-step-form
    [step]="editingStep()"
    [pipelineId]="currentPipeline()!.id!"
    [nextOrder]="getNextStepOrder()"
    (save)="saveStep($event)"
    (cancel)="closeStepForm()"
  />
}

<!-- Delete Confirmation Dialog -->
@if (showDeleteConfirm() && deletingPipeline(); as pipeline) {
  <ui-confirm-dialog
    title="Delete Pipeline"
    [message]="'Are you sure you want to delete this pipeline? This action cannot be undone.'"
    [details]="pipeline.name"
    confirmLabel="Delete Pipeline"
    cancelLabel="Cancel"
    confirmVariant="danger"
    (confirm)="confirmDelete()"
    (cancel)="cancelDelete()"
  />
}
